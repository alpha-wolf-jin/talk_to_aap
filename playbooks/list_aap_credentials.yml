---

- name: List all AAP Credentials
  hosts: localhost
  gather_facts: false
  vars:
    # Connection details (best practice: store these in Ansible Vault)
    controller_hostname: "192.168.122.20"
    controller_oauthtoken: "EIFnMuewWUVded037eBSNuX4lJlUBX"
    controller_validate_certs: false

  tasks:
    - name: Retrieve all credentials via API
      ansible.builtin.set_fact:
        all_credentials: "{{ lookup('ansible.controller.controller_api', 'credentials',
                                    host=controller_hostname,
                                    oauth_token=controller_oauthtoken,
                                    verify_ssl=controller_validate_certs,
                                    return_all=true) }}"

    - name: Display Credential Information (Single Credential)
      ansible.builtin.debug:
        msg: "Credential: {{ all_credentials.name }} | Type: {{ all_credentials.credential_type | default('N/A') }} | Organization: {{ all_credentials.organization | default('N/A') }} | Description: {{ all_credentials.description | default('N/A') }} (ID: {{ all_credentials.id }})"
      when:
        - all_credentials.name is defined
        - all_credentials.id is defined

    - name: Display Credential Information (Multiple Credentials)
      ansible.builtin.debug:
        msg: "Credential: {{ item.name }} | Type: {{ item.summary_fields.credential_type.name | default('N/A') }} | Organization: {{ item.summary_fields.organization.name | default('N/A') }} | Description: {{ item.description | default('N/A') }} (ID: {{ item.id }})"
      loop: "{{ (all_credentials[0] is defined) | ternary(all_credentials, []) }}"
      loop_control:
        label: "{{ item.name }}"

    - name: Display total credential count
      ansible.builtin.debug:
        msg: "Total credentials found: {{ all_credentials | length }}"
      when: all_credentials is iterable and all_credentials is not string

